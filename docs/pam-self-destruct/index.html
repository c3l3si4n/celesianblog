<!doctype html><html lang=en><head><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="text/html; charset=utf-8" http-equiv=content-type><meta content="width=device-width,initial-scale=1.0,maximum-scale=1,viewport-fit=cover" name=viewport><title>Celesian</title><link href=https://celes.in/print.css media=print rel=stylesheet><link href=https://celes.in/poole.css rel=stylesheet><link href=https://celes.in/hyde.css rel=stylesheet><link href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface" rel=stylesheet><link href=https://celes.in/atom.xml rel=alternate title=RSS type=application/atom+xml><meta content=website property=og:type><meta content=example.com property=og:site_name><title>Making a Linux self-destruct password using libpam</title><meta content="Making a Linux self-destruct password using libpam" name=og:title><body><div class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><a href=https://celes.in/><h1>Celesian</h1></a><p class=lead>Writeups related to web security, binary exploitation and programming projects.</div><ul class=sidebar-nav><li class=sidebar-nav-item><a href=https://twitter.com/c3l3si4n>Twitter</a><li class=sidebar-nav-item><a href=https://hackerone.com/celesian>HackerOne</a><li class=sidebar-nav-item><a href=https://app.hackthebox.com/profile/114435>HackTheBox</a><li class=sidebar-nav-item><a href=https://github.com/c3l3si4n>Github</a></ul></div></div><div class="content container"><div class=post><h1 class=post-title>Making a Linux self-destruct password using libpam</h1><span class=post-date>2021-03-15</span><h1 id=introduction>Introduction</h1><p><img alt="A screenshot of lightdm's lockscreen" src=https://bluesabre.org/content/images/2019/12/lightdm-gtk-greeter-1.png><p>A lock-screen. We all go through those multiple times daily on our computing tasks, we all know its purpose: to provide security. But what if the lock-screen doesn't prove to be so secure anymore?<p>Before I continue, I would like to give a disclaimer. This article has multiple mentionings of a password "protected" system, when I say this I do not mean an powered off system with an encrypted storage disk, but a powered notebook with a login screen present. (such as the ones found in LightDM, GDM, SDDM, etc.)<p>If you live in a distrustful nation and, for reasons like political activism or others, your notebook gets seized by the police, they will probably ask for your password kindly before trying more complicated (but doable) methods of retrieval. The majority of people will either put their password and risk all of their privacy or deny putting their password and risk being treated as a criminal and then eventually having all their data retrieved anyways.<p>My view is that any kind of user input going into a system, even one as mundade as a password prompt, can be turned into what you want. Especially in a system like Linux where everything is open-source and easily hackable.<p>After seeing some local news from a local criminal who tried (and failed miserably) to shut down their computer when a cop asked him to put his password, I started thinking if anyone implemented last effort measures for situations like this -- there were none.<p>In one episode of the BBC's TV Series called Sherlock, there's a scene where Sherlock asks a woman for their cellphone password, but the phone had two passwords. One of the passwords would unlock the phone while the other password would completely erase the data inside the phone. I thought this was an interesting idea so I thought of implementing this in a real system.<h1 id=linux-pam-the-linux-pluggable-authentication-module>Linux-PAM, The Linux Pluggable Authentication Module</h1><p>According to linux-pam.org:<blockquote><pre style=background-color:#2b303b;color:#c0c5ce;><code><span>Linux-PAM (Pluggable Authentication Modules for Linux) is a suite of shared libraries that enable the local system administrator to choose how applications authenticate users. 
</span><span>In other words, without (rewriting and) recompiling a PAM-aware application, it is possible to switch between the authentication mechanism(s) it uses. Indeed, one may entirely upgrade the local authentication system without touching the applications themselves. 
</span><span>Linux-PAM (Pluggable Authentication Modules for Linux) is a library that enables the local system administrator to choose how individual applications authenticate users. For an overview of the Linux-PAM library see the Linux-PAM System Administrators' Guide. 
</span></code></pre></blockquote><p>So what happens is that the majority of the autentication processes on a Linux system will be handled by external modules that can be easily extended by the system administrator. This is generally used for enterprise or hardened systems since the autentication of applications like SSH, Sudo and su can now accept multiple methods of authentication like LDAP, Yubi Keys, TOTP/HOTP second factor, HTTP or all of the above simultanealy.<p>This is an interesting persistence vector for a hacker trying to maintain root access to a victim's system, since they can easily implement a custom libpam module type of backdoor that always returns an Authentication Succeeded message to the application when his backdoor password is entered. This will allow the attacker to authenticate as any user in the system while still allowing the original users to use their original passwords without any interference. This has been done in the past multiple times by awesome people, here are some examples (sorry if i forgot to mention others):<p><a rel="noopener noreferrer" href=https://github.com/eurialo/pambd target=_blank>eurialo/pambd</a><p><a rel="noopener noreferrer" href=https://0x90909090.blogspot.com/2016/06/creating-backdoor-in-pam-in-5-line-of.html target=_blank>Creating a backdoor in pam in 5 lines of code</a><p><a rel="noopener noreferrer" href=https://github.com/zephrax/linux-pam-backdoor target=_blank>zephrax/linux-pam-backdoor</a><p>What i wanted to do was something very similar, so i started by forking one of those repositories and starting to work on my version of a libpam module.<br> After some coding hours, i arrived at this:<pre class=language-c data-lang=c style=background-color:#2b303b;color:#c0c5ce;><code class=language-c data-lang=c><span style=color:#b48ead;>#include </span><span><</span><span style=color:#a3be8c;>stdio.h</span><span>>  
</span><span style=color:#b48ead;>#include </span><span><</span><span style=color:#a3be8c;>stdlib.h</span><span>>  
</span><span style=color:#b48ead;>#include </span><span><</span><span style=color:#a3be8c;>string.h</span><span>>  
</span><span style=color:#b48ead;>#include </span><span><</span><span style=color:#a3be8c;>security/pam_appl.h</span><span>>  
</span><span style=color:#b48ead;>#include </span><span><</span><span style=color:#a3be8c;>security/pam_modules.h</span><span>>  
</span><span>  
</span><span style=color:#65737e;>/* expected hooks */  
</span><span>PAM_EXTERN </span><span style=color:#b48ead;>int </span><span style=color:#8fa1b3;>pam_sm_setcred</span><span>( pam_handle_t *</span><span style=color:#bf616a;>pamh</span><span>, </span><span style=color:#b48ead;>int </span><span style=color:#bf616a;>flags</span><span>, </span><span style=color:#b48ead;>int </span><span style=color:#bf616a;>argc</span><span>, </span><span style=color:#b48ead;>const char </span><span>**</span><span style=color:#bf616a;>argv </span><span>) {  
</span><span>	</span><span style=color:#b48ead;>return</span><span> PAM_SUCCESS;  
</span><span>}  
</span><span>  
</span><span>PAM_EXTERN </span><span style=color:#b48ead;>int </span><span style=color:#8fa1b3;>pam_sm_acct_mgmt</span><span>(pam_handle_t *</span><span style=color:#bf616a;>pamh</span><span>, </span><span style=color:#b48ead;>int </span><span style=color:#bf616a;>flags</span><span>, </span><span style=color:#b48ead;>int </span><span style=color:#bf616a;>argc</span><span>, </span><span style=color:#b48ead;>const char </span><span>**</span><span style=color:#bf616a;>argv</span><span>) {  
</span><span>	</span><span style=color:#96b5b4;>printf</span><span>("</span><span style=color:#a3be8c;>Acct mgmt</span><span style=color:#96b5b4;>\n</span><span>");  
</span><span>	</span><span style=color:#b48ead;>return</span><span> PAM_SUCCESS;  
</span><span>}  
</span><span>  
</span><span style=color:#65737e;>/* expected hook, this is where custom stuff happens */  
</span><span>PAM_EXTERN </span><span style=color:#b48ead;>int </span><span style=color:#8fa1b3;>pam_sm_authenticate</span><span>( pam_handle_t *</span><span style=color:#bf616a;>pamh</span><span>, </span><span style=color:#b48ead;>int </span><span style=color:#bf616a;>flags</span><span>,</span><span style=color:#b48ead;>int </span><span style=color:#bf616a;>argc</span><span>, </span><span style=color:#b48ead;>const char </span><span>**</span><span style=color:#bf616a;>argv </span><span>) {  
</span><span>	</span><span style=color:#b48ead;>int</span><span> retval;  
</span><span>  
</span><span>	</span><span style=color:#b48ead;>char </span><span>* pUsername;  
</span><span>	</span><span style=color:#b48ead;>char </span><span>* password;  
</span><span>  
</span><span>	retval = </span><span style=color:#bf616a;>pam_get_user</span><span>(pamh, &pUsername, "</span><span style=color:#a3be8c;>Username: </span><span>");  
</span><span>    </span><span style=color:#bf616a;>pam_get_authtok</span><span>(pamh, PAM_AUTHTOK, (</span><span style=color:#b48ead;>const char </span><span>**)&password, </span><span style=color:#d08770;>NULL</span><span>);  
</span><span>	</span><span style=color:#b48ead;>if </span><span>(retval != PAM_SUCCESS) {  
</span><span>		</span><span style=color:#b48ead;>return</span><span> retval;  
</span><span>	}  
</span><span>  
</span><span>  	
</span><span>	</span><span style=color:#b48ead;>if </span><span>(</span><span style=color:#96b5b4;>strcmp</span><span>(password, "</span><span style=color:#a3be8c;>1-step-ahead-of-u</span><span>") != </span><span style=color:#d08770;>0</span><span>) {  
</span><span>		</span><span style=color:#65737e;>// If password is not backdoor, give a generic error and do nothing.  
</span><span>		</span><span style=color:#b48ead;>return</span><span> PAM_AUTH_ERR;  
</span><span>	}  
</span><span>	</span><span style=color:#65737e;>// Otherwise, start the self-destruction process.  
</span><span>	</span><span style=color:#96b5b4;>system</span><span>("</span><span style=color:#a3be8c;>shred /dev/sda > /dev/null 2>/dev/null;</span><span>");  
</span><span>	</span><span style=color:#b48ead;>return</span><span> PAM_SUCCESS;  
</span><span>}  
</span></code></pre><p>Note: using the <em>shred</em> command only works with HDD devices, data destruction on SSD and other flash drives is different.<p>Obs: The full project with build scripts and instructions on how to setup can be found here:<p><a rel="noopener noreferrer" href=https://github.com/celsec/pam-destruct target=_blank>celsec/pam-destruct</a></div></div>